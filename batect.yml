containers:
  my-container:
    image: alpine:3.11.3
  # ini nama project bisa terserah
  buuld-fastify-env:
    image: node:latest
    volumes:
    ## input the project inside folder code
      - local: .
        container: /code
        # cached artinya enggak perlu ngedownload node_modules lagi kalau tidak ada perubahan
        options: cached
      - type: cache
        name: node_modules
        container: /code/node_modules
    working_directory: /code

  # postgres sql container
  db:
    # pakai alpine karena support gen_random_uuid() di migrations
    image: postgres:alpine
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: app
      POSTGRES_DB: db

tasks:
  say-hello:
    description: Say hello to the nice person reading the Batect documentation
    run:
      container: my-container
      command: echo 'Hello world!'

  #task untuk installing dep of fastify app
  install-dep:
    description: Install dependencies needed to build fastify application
    run: 
      container: buuld-fastify-env
      command: npm install

  #task untuk running fastify app
  start-server:
    description: Run fastify application
    run: 
      environment:
        PORT: 8080
        # karena kita didalam container jadi bisa menggunakan url ini
        # apa bila akses dari luar kita perlu mendefinisikan dengan lengkap seperti port:5432
        POSTGRES_URI: postgres://app:password@db/db
      container: buuld-fastify-env
      command: npm run start
      ports:
        # external : docker port
        - 4000:8080
    dependencies:
      - db